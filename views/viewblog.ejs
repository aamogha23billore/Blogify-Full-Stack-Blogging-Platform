<!DOCTYPE html>
<html lang="en">
<head>
  <%- include("./partials/head") %> 
  <title><%= blog.title %></title>
</head>
<body>
  <%- include("./partials/nav") %>

  <div class="container mt-4">
    <h1><%= blog.title %></h1>

    <% if (blog.coverImageUrl) { %>
      <img src="<%= blog.coverImageUrl %>" width="700px" class="mb-3">
    <% } %>

    <div class="mt-3">
      <%- blog.body %>  
    </div>

    <!-- Edit/Delete only for owner or admin -->
    <% if (user && (user.role === "admin" || blog.createdBy._id.toString() === user._id.toString())) { %>
      <div class="mt-3">
        <a href="/blog/<%= blog._id %>/edit" class="btn btn-warning btn-sm">Edit</a>
        
        <!-- THIS IS THE CORRECTED DELETE FORM -->
        <form action="/blog/<%= blog._id %>" method="POST" style="display:inline;">
          <input type="hidden" name="_method" value="DELETE">
          <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">Delete</button>
        </form>
      </div>
    <% } %>
  </div>

  <div class="container mt-4 d-flex align-items-center">
    <% if (blog.createdBy.profileImageUrl) { %>
      <img src="<%= blog.createdBy.profileImageUrl %>" width="50px" class="rounded-circle me-2">
    <% } %>
    <span><%= blog.createdBy.fullName %></span>
  </div>

  <div class="container mt-4">
    <h2>Comments (<%= comments.length %>)</h2>

    <% if (user) { %>
      <form action="/blog/comment/<%= blog._id %>" method="POST" class="mb-4">
        <div class="mb-3">
          <textarea class="form-control" name="content" placeholder="Write your comment..." rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-sm btn-primary">Submit</button>
      </form>
    <% } %>

    <div class="mt-3">
      <% comments.forEach(comment => { %>
        <div class="d-flex align-items-start mb-3">
          <% if (comment.createdBy.profileImageUrl) { %>
            <img src="<%= comment.createdBy.profileImageUrl %>" 
                 alt="User profile" 
                 width="40px" 
                 class="rounded-circle me-2">
          <% } %>
          <div>
            <strong><%= comment.createdBy.fullName %></strong><br>
            <div><%- comment.content %></div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <%- include("./partials/scripts") %>
</body>
</html>